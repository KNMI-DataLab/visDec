---
title: "Fog Detection"
author: "Martin Roth"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Fog Detection}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  fig.width  = 6,
  fig.height = 4
)
```

## Example how to use visDec
### Load required libaries
```{r, message=FALSE}
library(visDec)
library(ggplot2)
library(doParallel)
registerDoParallel()
library(imager)
```

### Computing basis image statistics
```{r}
filenames <- list.files("~/Dropbox/SWI_FogDetection/TrainingSet",
filenames <- list.files("~/Dropbox/SWI_FogDetection/OctoberDay/",
                        pattern=glob2rx("Meetterrein_*.jpg"),
                        full.names=TRUE)
#filenames <- list.files("../inst/extdata/Meetterrein/",
#                        pattern=glob2rx("Meetterrein_20151009*.jpg"),
#                        full.names=TRUE)
imageSummary <- foreach(file = iter(filenames),
                        .combine = rbind) %dopar% {
  fileInformation <- FileNameParser(file, "na*me_yyyymmdd_hhmm.jpg")
  im <- load.image(file)
  imGradient <- get_gradient(im, "xy", scheme = 2L)
  data.table(name = fileInformation$name,
             dateTime = fileInformation$dateTime,
             mean = mean(im), var = var(im),
             meanThresholdGradientX = mean(threshold(imGradient[[1]], 30)),
             meanThresholdGradientY = mean(threshold(imGradient[[2]], 30))
             )
}
```



### Load sensor values
```{r, fig.show='hold'}
sensorFiles <- list.files("../inst/extdata/Sensor",
                          pattern=glob2rx("MOR_DeBilt*.txt"),
                          full.names=TRUE)
sensorData <- ReadMORSensorData(sensorFiles)
setkey(sensorData, dateTime)
setkey(imageSummary, dateTime)
imageSummary <- merge(imageSummary, sensorData)
```

### Time series
```{r, fig.show='hold'}
ggplot(imageSummary, aes(x = dateTime, y = mean)) + geom_line() + xlab("")
ggplot(imageSummary, aes(x = dateTime, y = var)) + geom_line() + xlab("")
ggplot(imageSummary, aes(x = dateTime, y = sqrt(var)/mean)) + geom_line() +
  xlab("") 
ggplot(imageSummary, aes(x = dateTime, y= FS261)) + geom_line() +
  xlab("") 
```

```{r, fig.show='hold'}
ggplot(imageSummary[hour(dateTime) %in% seq(5, 10, by=1), ],
       aes(x = dateTime, y = var)) + geom_line() + xlab("")
```


### Scatter plots
```{r, fig.show='hold'}
imageSummary[, visibility := factor(2000)]
imageSummary[FS261 < 1000, visibility := factor(1000)]
imageSummary[FS261 < 500, visibility := factor(500)]
imageSummary[FS261 < 200, visibility := factor(200)]
imageSummary[, transmission := read.csv("~/Dropbox/SWI_FogDetection/TrainingSet/Values.csv", sep=";")[, 3]]
ggplot(imageSummary, aes(x = mean, y = FS261)) + geom_point()
ggplot(imageSummary, aes(x = var, y = FS261)) + geom_point()
ggplot(imageSummary, aes(x = mean, y = var, col = visibility)) + geom_point()
ggplot(imageSummary, aes(x = meanThresholdGradientX, y = meanThresholdGradientY, col = visibility)) + geom_point()
ggplot(imageSummary[hour %in% seq(6, 16, by = 1), ], aes(x = log(FS261), y = meanThresholdGradientY, col = visibility)) + geom_point()
ggplot(imageSummary[hour %in% c(seq(0, 4, by = 1), seq(18, 24, by = 1)), ], aes(x = log(FS261), y = meanThresholdGradientY, col = visibility)) + geom_point()
ggplot(imageSummary[hour %in% c(seq(0, 4, by = 1), seq(18, 24, by = 1)), ], aes(x = log(FS261), y = transmission, col = visibility)) + geom_point()
ggplot(imageSummary[hour %in% seq(6, 16, by = 1), ], aes(x = log(FS261), y = transmission, col = visibility)) + geom_point()
ggplot(imageSummary, aes(x = log(FS261), y = transmission)) + geom_point() + geom_smooth(method="lm") + geom_quantile(quantiles=0.5, col = 2)
ggplot(imageSummary[hour %in% seq(6, 16, by = 1), ], aes(x = meanThresholdGradientY, y = transmission)) + geom_point() + geom_quantile(quantiles=0.5)
```

#```{r}
#im <- grayscale(subim(load.image("~/Dropbox/SWI_FogDetection/TrainingSet/Day/Meetterrein_20151009_0910.jpg"), y > 20))
#im2 <- grayscale(subim(load.image("~/Dropbox/SWI_FogDetection/TrainingSet/Day/Meetterrein_20151010_1510.jpg"), y > 20))
#rowIm <- imsplit(im, "y")
#rowIm2 <- imsplit(im2, "y")
#fn <- function(x) {
#  return(abs(fft(as.numeric(x))))
#}
#fourierCoef <- foreach(i =1 : length(rowIm), .combine = "rbind") %do% {
#  return(fn(rowIm[[i]]))
#}
#fourierCoefFog <- foreach(i =1 : length(rowIm), .combine = "rbind") %do% {
#  return(fn(rowIm2[[i]]))
#}
#fourierCoefFog2 <- fourierCoefFog
#fourierCoefFog2[fourierCoefFog > 1] <- 1
#```

```{r}
stopImplicitCluster()
```
